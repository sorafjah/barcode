<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100均レジごっこ</title>
    <!-- バーコード読み取りライブラリ -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* 基本設定：文字を大きく、高コントラストに */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #000000;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* スクロール禁止 */
        }

        /* 共通ボタンデザイン */
        button {
            font-size: 1.5rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            padding: 15px;
            touch-action: manipulation; /* タップの反応を良くする */
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- スタート画面 --- */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f8ff;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #btn-start {
            background-color: #4CAF50; /* 緑 */
            color: white;
            width: 80%;
            height: 150px;
            font-size: 2rem;
        }

        /* --- メイン画面 --- */
        #main-app {
            display: none; /* 最初は非表示 */
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        /* 上部：合計金額表示エリア */
        header {
            background-color: #222;
            color: #fff;
            padding: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        .display-label {
            font-size: 1rem;
            color: #aaa;
        }
        .display-value {
            font-size: 3.5rem; /* 極大サイズ */
            font-weight: bold;
            color: #adff2f; /* 蛍光緑で見やすく */
            line-height: 1.1;
        }
        .count-info {
            font-size: 1.5rem;
            color: #fff;
        }

        /* スキャンエリア */
        #scanner-container {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #reader {
            width: 100%;
            height: 100%;
        }
        /* スキャン中の商品名表示 */
        #last-scanned {
            background-color: #ffeb3b; /* 黄色背景 */
            color: #000;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 2px solid #000;
        }
        #item-name {
            font-size: 1.5rem;
        }
        #item-code {
            font-size: 0.9rem;
            color: #555;
        }

        /* 操作ボタンエリア */
        #controls {
            padding: 10px;
            background-color: #eee;
            display: flex;
            gap: 10px;
            height: 100px; /* 固定の高さ */
        }
        #btn-pay {
            flex: 2; /* 幅を広く */
            background-color: #FFD700; /* 金色/黄色 */
            color: #000;
            font-size: 1.8rem;
        }
        #btn-reset {
            flex: 1;
            background-color: #ff4d4d; /* 赤 */
            color: white;
            font-size: 1.2rem;
        }

        /* --- お支払いモーダル --- */
        #payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 500;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .total-price-huge {
            font-size: 5rem;
            font-weight: bold;
            color: #d32f2f;
            margin: 20px 0;
        }
        #btn-next-customer {
            background-color: #4CAF50;
            color: white;
            width: 80%;
            height: 120px;
            font-size: 2rem;
            margin-top: 30px;
        }

    </style>
</head>
<body>

    <!-- 1. スタート画面 (クリックでAudioContextなどを初期化するため必須) -->
    <div id="start-screen">
        <h1>100均レジごっこ</h1>
        <p>カメラと音を使います</p>
        <button id="btn-start">レジをはじめる</button>
    </div>

    <!-- 2. アプリ本体 -->
    <div id="main-app">
        <!-- 合計金額表示 -->
        <header>
            <div class="count-info"><span id="count-display">0</span>点</div>
            <div class="display-value">¥<span id="total-display">0</span></div>
        </header>

        <!-- 直近のスキャン情報 -->
        <div id="last-scanned">
            <span id="item-name">いらっしゃいませ</span>
            <span id="item-code">バーコードをうつしてください</span>
        </div>

        <!-- カメラ映像エリア -->
        <div id="scanner-container">
            <div id="reader"></div>
        </div>

        <!-- 操作ボタン -->
        <div id="controls">
            <button id="btn-reset">最初から</button>
            <button id="btn-pay">お支払い</button>
        </div>
    </div>

    <!-- 3. お支払い画面（モーダル） -->
    <div id="payment-modal">
        <h2>お会計</h2>
        <div class="total-price-huge">¥<span id="modal-total">0</span></div>
        <p style="font-size: 1.5rem;">ありがとうございました！</p>
        <button id="btn-next-customer">つぎの人へ</button>
    </div>

    <script>
        // --- 変数定義 ---
        let count = 0;
        let total = 0;
        const UNIT_PRICE = 110; // 100円ショップ価格（税込）
        let html5QrcodeScanner = null;
        let isScanningLocked = false; // 連続スキャン防止用フラグ
        let audioCtx = null; // Web Audio API用

        // --- DOM要素 ---
        const startScreen = document.getElementById('start-screen');
        const mainApp = document.getElementById('main-app');
        const countDisplay = document.getElementById('count-display');
        const totalDisplay = document.getElementById('total-display');
        const itemNameDisplay = document.getElementById('item-name');
        const itemCodeDisplay = document.getElementById('item-code');
        const paymentModal = document.getElementById('payment-modal');
        const modalTotal = document.getElementById('modal-total');

        // --- 1. 初期化とオーディオ設定 ---
        
        // 「レジをはじめる」ボタン
        document.getElementById('btn-start').addEventListener('click', async () => {
            // AudioContextの初期化（iOS対応のためユーザー操作内で行う）
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // 画面切り替え
            startScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            
            // スキャナー起動
            startScanner();
        });

        // 「ピッ」という電子音を生成する関数
        function playBeep() {
            if (!audioCtx) return;
            // 停止していたら再開（iOS対策）
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = 'square'; // 電子音っぽい矩形波
            oscillator.frequency.setValueAtTime(1200, audioCtx.currentTime); // 1200Hz
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            
            // 0.1秒後に音を止める
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        // 音声読み上げ関数
        function speakText(text) {
            if (!window.speechSynthesis) return;
            
            // 既存の読み上げをキャンセル
            window.speechSynthesis.cancel();

            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0; // 速度
            uttr.pitch = 1.2; // 少し高めの声で
            uttr.volume = 1.0;
            window.speechSynthesis.speak(uttr);
        }

        // --- 2. スキャナー機能 ---

        function startScanner() {
            // 既に起動していたら何もしない
            if (html5QrcodeScanner) return;

            // 画面の幅に合わせて正方形の読み取り範囲を設定
            const width = window.innerWidth;
            const qrboxSize = Math.min(250, width * 0.7);

            html5QrcodeScanner = new Html5Qrcode("reader");

            const config = { 
                fps: 10, 
                qrbox: { width: qrboxSize, height: 150 },
                aspectRatio: 1.0
            };

            // バックカメラ（環境カメラ）を優先
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess, 
                onScanFailure
            ).catch(err => {
                console.error("Camera start failed", err);
                alert("カメラの起動に失敗しました。ブラウザの権限設定を確認してください。");
            });
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.error("Stop failed", err));
            }
        }

        // スキャン成功時の処理
        function onScanSuccess(decodedText, decodedResult) {
            // ロック中は無視（連続読み取り防止）
            if (isScanningLocked) return;

            // 1.5秒間ロックする
            isScanningLocked = true;
            setTimeout(() => { isScanningLocked = false; }, 1500);

            // 計算処理
            count++;
            total += UNIT_PRICE;

            // 画面更新
            updateDisplay(decodedText);

            // 音の演出
            playBeep();
            
            // 少し遅れて読み上げ（「ピッ」と重ならないように）
            setTimeout(() => {
                speakText("ひゃくじゅうえん");
            }, 200);
        }

        function onScanFailure(error) {
            // 読み取れていない間も呼ばれ続けるので、基本は何もしない
            // console.warn(`Code scan error = ${error}`);
        }

        // --- 3. 画面更新とロジック ---

        function updateDisplay(code) {
            countDisplay.textContent = count;
            totalDisplay.textContent = total.toLocaleString(); // カンマ区切り
            
            // 商品表示更新
            itemNameDisplay.textContent = "100円ショップの商品";
            itemCodeDisplay.textContent = `コード: ${code}`;
            
            // 視覚的フィードバック（商品名を一瞬光らせる）
            const lastScannedBox = document.getElementById('last-scanned');
            lastScannedBox.style.backgroundColor = "#fff";
            setTimeout(() => {
                lastScannedBox.style.backgroundColor = "#ffeb3b";
            }, 200);
        }

        // --- 4. ボタン操作 ---

        // お支払いボタン
        document.getElementById('btn-pay').addEventListener('click', () => {
            if (count === 0) return; // 0点なら反応しない

            // スキャン停止（バッテリー節約と誤動作防止）
            if (html5QrcodeScanner) {
                html5QrcodeScanner.pause(true); 
            }

            // モーダル表示
            modalTotal.textContent = total.toLocaleString();
            paymentModal.style.display = 'flex';
            
            // 合計金額を読み上げ
            speakText(`ごうけい、${total}円です`);
        });

        // つぎの人へ（リセット）ボタン（モーダル内）
        document.getElementById('btn-next-customer').addEventListener('click', () => {
            resetRegister();
            paymentModal.style.display = 'none';
            
            // スキャナー再開
            if (html5QrcodeScanner) {
                html5QrcodeScanner.resume();
            }
        });

        // 最初からボタン（メイン画面左下：スキャン中に間違えた時など）
        document.getElementById('btn-reset').addEventListener('click', () => {
            if(confirm("最初からやりなおしますか？")) {
                resetRegister();
            }
        });

        function resetRegister() {
            count = 0;
            total = 0;
            countDisplay.textContent = "0";
            totalDisplay.textContent = "0";
            itemNameDisplay.textContent = "いらっしゃいませ";
            itemCodeDisplay.textContent = "バーコードをうつしてください";
            speakText("いらっしゃいませ");
        }

    </script>
</body>
</html>
