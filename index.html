<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100均レジごっこ</title>
    <!-- バーコード読み取りライブラリ -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* 基本設定：明るくポップな色使いに */
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif; /* 日本語フォント優先 */
            margin: 0;
            padding: 0;
            background-color: #fff8e1; /* 薄い黄色背景 */
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* スクロール禁止 */
        }

        /* 共通ボタンデザイン */
        button {
            font-size: 1.4rem;
            font-weight: bold;
            border: none;
            border-radius: 20px; /* 丸みを強く */
            cursor: pointer;
            padding: 10px;
            touch-action: manipulation;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1); /* 立体感 */
            transition: transform 0.1s;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }

        /* --- スタート画面 --- */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e0f7fa; /* 水色背景 */
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }
        #btn-start {
            background-color: #00bcd4; /* シアン */
            color: white;
            width: 80%;
            height: 120px;
            font-size: 2rem;
            border: 4px solid #fff;
        }

        /* --- メイン画面 --- */
        #main-app {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        /* 上部：合計金額表示エリア */
        header {
            background-color: #ff9800; /* 明るいオレンジ */
            color: #fff;
            padding: 15px 10px;
            text-align: center;
            flex-shrink: 0;
            border-bottom: 4px solid #f57c00;
        }
        .count-info {
            font-size: 1.2rem;
            background: rgba(255,255,255,0.2);
            display: inline-block;
            padding: 2px 15px;
            border-radius: 15px;
            margin-bottom: 5px;
        }
        .display-value {
            font-size: 4rem; /* 極大サイズ */
            font-weight: bold;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            line-height: 1.0;
        }

        /* 直近のスキャン情報 */
        #last-scanned {
            background-color: #fff;
            color: #333;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid #ddd;
        }
        #item-name {
            font-size: 1.4rem;
            color: #e91e63; /* ピンク */
        }
        #item-code {
            font-size: 0.8rem;
            color: #888;
        }

        /* カメラ映像エリア */
        #scanner-container {
            flex: 1;
            position: relative;
            background: #fafafa;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #reader {
            width: 100%;
            height: 100%;
        }
        /* スキャンガイド枠のカスタマイズ用（ライブラリのCSSを上書きできない場合もあるが念のため） */
        #reader__scan_region {
            border: 4px solid #ff9800 !important;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(255, 255, 255, 0.5) !important;
        }

        /* 操作ボタンエリア */
        #controls {
            padding: 15px;
            background-color: #fff8e1;
            display: flex;
            gap: 15px;
            height: 100px;
        }
        #btn-pay {
            flex: 2;
            background-color: #ffeb3b; /* 黄色 */
            color: #d84315; /* 濃いオレンジ文字 */
            border: 2px solid #fbc02d;
            font-size: 1.8rem;
        }
        #btn-reset {
            flex: 1;
            background-color: #ef9a9a; /* 薄い赤 */
            color: #b71c1c;
            font-size: 1.0rem;
        }

        /* --- お支払いモーダル --- */
        #payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 248, 225, 0.98); /* 背景も明るく */
            z-index: 500;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .total-price-huge {
            font-size: 5rem;
            font-weight: bold;
            color: #ff5722; /* 鮮やかな赤オレンジ */
            margin: 20px 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        #btn-next-customer {
            background-color: #8bc34a; /* 黄緑 */
            color: #33691e;
            width: 80%;
            height: 100px;
            font-size: 2rem;
            margin-top: 30px;
            border-bottom: 6px solid #558b2f;
        }

    </style>
</head>
<body>

    <!-- 1. スタート画面 -->
    <div id="start-screen">
        <h1 style="color: #0097a7;">100均レジごっこ</h1>
        <p>カメラへのアクセスを<br>「許可」してください</p>
        <button id="btn-start">レジをはじめる</button>
    </div>

    <!-- 2. アプリ本体 -->
    <div id="main-app">
        <header>
            <div class="count-info"><span id="count-display">0</span>点</div>
            <div class="display-value">¥<span id="total-display">0</span></div>
        </header>

        <div id="last-scanned">
            <span id="item-name">いらっしゃいませ</span>
            <span id="item-code">商品をスキャンしてね</span>
        </div>

        <div id="scanner-container">
            <div id="reader"></div>
        </div>

        <div id="controls">
            <button id="btn-reset">最初から</button>
            <button id="btn-pay">お支払い</button>
        </div>
    </div>

    <!-- 3. お支払い画面 -->
    <div id="payment-modal">
        <h2 style="color: #555;">お会計</h2>
        <div class="total-price-huge">¥<span id="modal-total">0</span></div>
        <p style="font-size: 1.5rem; color: #555;">ありがとうございました！</p>
        <button id="btn-next-customer">つぎの人へ</button>
    </div>

    <script>
        // --- 変数定義 ---
        let count = 0;
        let total = 0;
        const UNIT_PRICE = 110; 
        let html5QrcodeScanner = null;
        let isScanningLocked = false; 
        let audioCtx = null; 

        // --- DOM要素 ---
        const startScreen = document.getElementById('start-screen');
        const mainApp = document.getElementById('main-app');
        const countDisplay = document.getElementById('count-display');
        const totalDisplay = document.getElementById('total-display');
        const itemNameDisplay = document.getElementById('item-name');
        const itemCodeDisplay = document.getElementById('item-code');
        const paymentModal = document.getElementById('payment-modal');
        const modalTotal = document.getElementById('modal-total');

        // --- 初期化 ---
        document.getElementById('btn-start').addEventListener('click', async () => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            startScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            
            startScanner();
        });

        // --- 音声関連 ---
        function playBeep() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = 'sine'; // 矩形波(square)からサイン波(sine)に変更して少し柔らかい音に
            oscillator.frequency.setValueAtTime(1500, audioCtx.currentTime); // 高めの音
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.start();
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
            oscillator.stop(audioCtx.currentTime + 0.1);
        }

        function speakText(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'ja-JP';
            uttr.rate = 1.0;
            uttr.pitch = 1.2;
            window.speechSynthesis.speak(uttr);
        }

        // --- スキャナー機能 ---
        function startScanner() {
            if (html5QrcodeScanner) return;

            const width = window.innerWidth;
            // 読み取り範囲を少し広げる
            const qrboxWidth = Math.min(320, width * 0.85); 
            const qrboxHeight = 180; 

            // 様々なバーコード形式に対応
            const formats = [ 
                Html5QrcodeSupportedFormats.EAN_13, // JAN(標準)
                Html5QrcodeSupportedFormats.EAN_8,  // JAN(短縮)
                Html5QrcodeSupportedFormats.UPC_A,  // 海外製品など
                Html5QrcodeSupportedFormats.UPC_E
            ];

            // ★改善点：experimentalFeaturesを使って、ブラウザネイティブの検出機能を利用する
            // これによりAndroid等での認識率と速度が大幅に向上する場合があります
            html5QrcodeScanner = new Html5Qrcode("reader", { 
                formatsToSupport: formats,
                verbose: false,
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                }
            });

            const config = { 
                fps: 15, // フレームレートを少し上げる
                qrbox: { width: qrboxWidth, height: qrboxHeight },
                aspectRatio: 1.0,
                // 焦点合わせのために、ビデオ設定を細かく指定
                videoConstraints: {
                    facingMode: "environment",
                    focusMode: "continuous" // オートフォーカス（対応ブラウザのみ）
                }
            };

            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess, 
                onScanFailure
            ).catch(err => {
                console.error("Camera start failed", err);
                showCameraError();
            });
        }

        // カメラエラー時の案内表示
        function showCameraError() {
            alert(
                "カメラを起動できませんでした。\n\n" +
                "【対処方法】\n" +
                "1. いったんブラウザを閉じてください。\n" +
                "2. スマホの「設定」アプリを開きます。\n" +
                "3. アプリ一覧から今使っているブラウザ(Safari/Chromeなど)を探します。\n" +
                "4. 「カメラ」の許可をONにしてください。\n" +
                "5. もう一度このページを開いてください。"
            );
        }

        function stopScanner() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.error("Stop failed", err));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            if (isScanningLocked) return;

            isScanningLocked = true;
            setTimeout(() => { isScanningLocked = false; }, 1500);

            count++;
            total += UNIT_PRICE;

            updateDisplay(decodedText);
            playBeep();
            
            // 読み上げのタイミング調整
            setTimeout(() => {
                speakText("ひゃくじゅうえん");
            }, 100);
        }

        function onScanFailure(error) {
            // エラーログは抑制
        }

        // --- 画面更新 ---
        function updateDisplay(code) {
            countDisplay.textContent = count;
            totalDisplay.textContent = total.toLocaleString();
            
            itemNameDisplay.textContent = "100円ショップの商品";
            itemCodeDisplay.textContent = `コード: ${code}`;
            
            const lastScannedBox = document.getElementById('last-scanned');
            // フラッシュ演出の色も変更
            lastScannedBox.style.backgroundColor = "#ffe0b2"; 
            setTimeout(() => {
                lastScannedBox.style.backgroundColor = "#ffffff";
            }, 200);
        }

        // --- ボタン操作 ---
        document.getElementById('btn-pay').addEventListener('click', () => {
            if (count === 0) return; 

            if (html5QrcodeScanner) {
                html5QrcodeScanner.pause(true); 
            }

            modalTotal.textContent = total.toLocaleString();
            paymentModal.style.display = 'flex';
            speakText(`ごうけい、${total}円です`);
        });

        document.getElementById('btn-next-customer').addEventListener('click', () => {
            resetRegister();
            paymentModal.style.display = 'none';
            if (html5QrcodeScanner) {
                html5QrcodeScanner.resume();
            }
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            if(confirm("最初からやりなおしますか？")) {
                resetRegister();
            }
        });

        function resetRegister() {
            count = 0;
            total = 0;
            countDisplay.textContent = "0";
            totalDisplay.textContent = "0";
            itemNameDisplay.textContent = "いらっしゃいませ";
            itemCodeDisplay.textContent = "商品をスキャンしてね";
            speakText("いらっしゃいませ");
        }
    </script>
</body>
</html>
